"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[495],{3905:function(e,a,t){t.d(a,{Zo:function(){return p},kt:function(){return d}});var n=t(7294);function r(e,a,t){return a in e?Object.defineProperty(e,a,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[a]=t,e}function s(e,a){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);a&&(n=n.filter((function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable}))),t.push.apply(t,n)}return t}function l(e){for(var a=1;a<arguments.length;a++){var t=null!=arguments[a]?arguments[a]:{};a%2?s(Object(t),!0).forEach((function(a){r(e,a,t[a])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):s(Object(t)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(t,a))}))}return e}function o(e,a){if(null==e)return{};var t,n,r=function(e,a){if(null==e)return{};var t,n,r={},s=Object.keys(e);for(n=0;n<s.length;n++)t=s[n],a.indexOf(t)>=0||(r[t]=e[t]);return r}(e,a);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(n=0;n<s.length;n++)t=s[n],a.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var i=n.createContext({}),c=function(e){var a=n.useContext(i),t=a;return e&&(t="function"==typeof e?e(a):l(l({},a),e)),t},p=function(e){var a=c(e.components);return n.createElement(i.Provider,{value:a},e.children)},m={inlineCode:"code",wrapper:function(e){var a=e.children;return n.createElement(n.Fragment,{},a)}},u=n.forwardRef((function(e,a){var t=e.components,r=e.mdxType,s=e.originalType,i=e.parentName,p=o(e,["components","mdxType","originalType","parentName"]),u=c(t),d=r,h=u["".concat(i,".").concat(d)]||u[d]||m[d]||s;return t?n.createElement(h,l(l({ref:a},p),{},{components:t})):n.createElement(h,l({ref:a},p))}));function d(e,a){var t=arguments,r=a&&a.mdxType;if("string"==typeof e||r){var s=t.length,l=new Array(s);l[0]=u;var o={};for(var i in a)hasOwnProperty.call(a,i)&&(o[i]=a[i]);o.originalType=e,o.mdxType="string"==typeof e?e:r,l[1]=o;for(var c=2;c<s;c++)l[c]=t[c];return n.createElement.apply(null,l)}return n.createElement.apply(null,t)}u.displayName="MDXCreateElement"},6658:function(e,a,t){t.r(a),t.d(a,{contentTitle:function(){return b},default:function(){return g},frontMatter:function(){return k},metadata:function(){return y},toc:function(){return N}});var n=t(3117),r=t(102),s=t(7294),l=t(3905),o=t(2389),i=t(4726),c=t(6010),p="tabItem_LplD";function m(e){var a,t,r,l=e.lazy,o=e.block,m=e.defaultValue,u=e.values,d=e.groupId,h=e.className,k=s.Children.map(e.children,(function(e){if((0,s.isValidElement)(e)&&void 0!==e.props.value)return e;throw new Error("Docusaurus error: Bad <Tabs> child <"+("string"==typeof e.type?e.type:e.type.name)+'>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.')})),b=null!=u?u:k.map((function(e){var a=e.props;return{value:a.value,label:a.label,attributes:a.attributes}})),y=(0,i.lx)(b,(function(e,a){return e.value===a.value}));if(y.length>0)throw new Error('Docusaurus error: Duplicate values "'+y.map((function(e){return e.value})).join(", ")+'" found in <Tabs>. Every value needs to be unique.');var N=null===m?m:null!=(a=null!=m?m:null==(t=k.find((function(e){return e.props.default})))?void 0:t.props.value)?a:null==(r=k[0])?void 0:r.props.value;if(null!==N&&!b.some((function(e){return e.value===N})))throw new Error('Docusaurus error: The <Tabs> has a defaultValue "'+N+'" but none of its children has the corresponding value. Available values are: '+b.map((function(e){return e.value})).join(", ")+". If you intend to show no default tab, use defaultValue={null} instead.");var f=(0,i.UB)(),g=f.tabGroupChoices,v=f.setTabGroupChoices,w=(0,s.useState)(N),x=w[0],C=w[1],j=[],D=(0,i.o5)().blockElementScrollPositionUntilNextRender;if(null!=d){var T=g[d];null!=T&&T!==x&&b.some((function(e){return e.value===T}))&&C(T)}var _=function(e){var a=e.currentTarget,t=j.indexOf(a),n=b[t].value;n!==x&&(D(a),C(n),null!=d&&v(d,n))},W=function(e){var a,t=null;switch(e.key){case"ArrowRight":var n=j.indexOf(e.currentTarget)+1;t=j[n]||j[0];break;case"ArrowLeft":var r=j.indexOf(e.currentTarget)-1;t=j[r]||j[j.length-1]}null==(a=t)||a.focus()};return s.createElement("div",{className:"tabs-container"},s.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,c.Z)("tabs",{"tabs--block":o},h)},b.map((function(e){var a=e.value,t=e.label,r=e.attributes;return s.createElement("li",(0,n.Z)({role:"tab",tabIndex:x===a?0:-1,"aria-selected":x===a,key:a,ref:function(e){return j.push(e)},onKeyDown:W,onFocus:_,onClick:_},r,{className:(0,c.Z)("tabs__item",p,null==r?void 0:r.className,{"tabs__item--active":x===a})}),null!=t?t:a)}))),l?(0,s.cloneElement)(k.filter((function(e){return e.props.value===x}))[0],{className:"margin-vert--md"}):s.createElement("div",{className:"margin-vert--md"},k.map((function(e,a){return(0,s.cloneElement)(e,{key:a,hidden:e.props.value!==x})}))))}function u(e){var a=(0,o.Z)();return s.createElement(m,(0,n.Z)({key:String(a)},e))}var d=function(e){var a=e.children,t=e.hidden,n=e.className;return s.createElement("div",{role:"tabpanel",hidden:t,className:n},a)},h=["components"],k={},b="\ud83d\ude84 Setup and run a Calamari collator",y={unversionedId:"collator/SetupAndRun",id:"collator/SetupAndRun",title:"\ud83d\ude84 Setup and run a Calamari collator",description:"Installation",source:"@site/docs/collator/SetupAndRun.md",sourceDirName:"collator",slug:"/collator/SetupAndRun",permalink:"/docs/collator/SetupAndRun",editUrl:"https://github.com/Manta-Network/docs/edit/main/docs/collator/SetupAndRun.md",tags:[],version:"current",frontMatter:{},sidebar:"docs",previous:{title:"\ud83d\udc69\ud83c\udffc\u200d\ud83d\udcbb How to apply to run a Calamari collator",permalink:"/docs/collator/HowToApply"},next:{title:"\ud83d\udc94 Leaving the collator program",permalink:"/docs/collator/HowToLeave"}},N=[{value:"Installation",id:"installation",children:[],level:2},{value:"Configuration",id:"configuration",children:[{value:"parameters with special significance for collator maintainers",id:"parameters-with-special-significance-for-collator-maintainers",children:[],level:3},{value:"firewall configuration",id:"firewall-configuration",children:[],level:3}],level:2},{value:"Running",id:"running",children:[],level:2},{value:"Collator session (aura) keys",id:"collator-session-aura-keys",children:[{value:"bind the collator account to the aura session key",id:"bind-the-collator-account-to-the-aura-session-key",children:[],level:3}],level:2},{value:"Sync",id:"sync",children:[],level:2},{value:"Wait",id:"wait",children:[],level:2}],f={toc:N};function g(e){var a=e.components,s=(0,r.Z)(e,h);return(0,l.kt)("wrapper",(0,n.Z)({},f,s,{components:a,mdxType:"MDXLayout"}),(0,l.kt)("h1",{id:"-setup-and-run-a-calamari-collator"},"\ud83d\ude84 Setup and run a Calamari collator"),(0,l.kt)("h2",{id:"installation"},"Installation"),(0,l.kt)(u,{groupId:"os",mdxType:"Tabs"},(0,l.kt)(d,{value:"docker",label:"docker",mdxType:"TabItem"},"- pull the latest calamari container",(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"#!/bin/bash\n\ndocker pull mantanetwork/calamari:latest\n"))),(0,l.kt)(d,{value:"fedora",label:"fedora",mdxType:"TabItem"},(0,l.kt)("p",null,"the manta .rpm package contains:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"the manta binary (which is also used to run calamari)"),(0,l.kt)("li",{parentName:"ul"},"manta and calamari systemd services"),(0,l.kt)("li",{parentName:"ul"},"manta, calamari, polkadot and kusama chain specifications"),(0,l.kt)("li",{parentName:"ul"},"a script which runs after installation and creates the manta system account which the systemd service runs under")),(0,l.kt)("p",null,"get started (see also: ",(0,l.kt)("a",{parentName:"p",href:"https://rpm.manta.systems/"},"rpm.manta.systems"),"):"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"add the manta .rpm repository"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"#!/bin/bash\n\nsudo dnf install dnf-plugins-core\nsudo dnf config-manager --add-repo https://rpm.manta.systems/manta.repo\nsudo dnf config-manager --set-enabled manta\nsudo dnf update\n"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"install manta"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"#!/bin/bash\n\nsudo dnf install manta\n"))))),(0,l.kt)(d,{value:"ubuntu",label:"ubuntu",mdxType:"TabItem"},(0,l.kt)("p",null,"the manta .deb package contains:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"the manta binary (which is also used to run calamari)"),(0,l.kt)("li",{parentName:"ul"},"manta and calamari systemd services"),(0,l.kt)("li",{parentName:"ul"},"manta, calamari, polkadot and kusama chain specifications"),(0,l.kt)("li",{parentName:"ul"},"a script which runs after installation and creates the manta system account which the systemd service runs under")),(0,l.kt)("p",null,"get started (see also: ",(0,l.kt)("a",{parentName:"p",href:"https://deb.manta.systems/"},"deb.manta.systems"),"):"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"add the manta .deb repository"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"#!/bin/bash\n\nsudo curl -o /usr/share/keyrings/manta.gpg https://deb.manta.systems/manta.gpg\nsudo curl -o /etc/apt/sources.list.d/manta.list https://deb.manta.systems/manta.list\nsudo apt update\n"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"install manta"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"#!/bin/bash\n\nsudo apt install manta\n"))))),(0,l.kt)(d,{value:"linux",label:"other linux",mdxType:"TabItem"},(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"download binary, chain specifications and systemd unit file"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"#!/bin/bash\n\nmanta_version=3.1.4\n\n# binary\nsudo curl -Lo /usr/local/bin/manta https://github.com/Manta-Network/Manta/releases/download/v${manta_version}/manta\nsudo ln -srf /usr/local/bin/manta /usr/local/bin/calamari\n\n# chainspecs\nsudo mkdir -p /usr/share/substrate\nsudo curl -Lo /usr/share/substrate/calamari.json https://raw.githubusercontent.com/Manta-Network/Manta/v3.0.9/genesis/calamari-genesis.json\nsudo curl -Lo /usr/share/substrate/kusama.json https://raw.githubusercontent.com/paritytech/polkadot/master/node/service/res/kusama.json\n\n# systemd unit file\nsudo curl -Lo /etc/systemd/system/calamari.service https://raw.githubusercontent.com/Manta-Network/Manta/deb-rpm/scripts/package/calamari.service\n"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"create the manta system account which the systemd service runs under"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"#!/bin/bash\n\nsudo groupadd --system manta\nsudo useradd \\\n  --system \\\n  --gid manta \\\n  --home-dir /var/lib/substrate \\\n  --create-home \\\n  --shell /sbin/nologin \\\n  --comment 'service account for manta and calamari services' \\\n  manta\n")))))),(0,l.kt)("h2",{id:"configuration"},"Configuration"),(0,l.kt)("p",null,"some extra command line parameters are required or helpful for collating."),(0,l.kt)(u,{groupId:"os",mdxType:"Tabs"},(0,l.kt)(d,{value:"fedora",label:"fedora",mdxType:"TabItem"},(0,l.kt)("p",null,"edit the calamari service unit file to include collation parameters in the ",(0,l.kt)("inlineCode",{parentName:"p"},"ExecStart")," command."),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"/usr/lib/systemd/system/calamari.service")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ini"},"ExecStart=/usr/bin/calamari \\\n    --collator \\\n    --name 'my parachain collator node name' \\\n    --chain /usr/share/substrate/calamari.json \\\n    --base-path /var/lib/substrate \\\n    --port 31333 \\\n    --ws-port 9144 \\\n    --ws-max-connections 100 \\\n    --rpc-port 9133 \\\n    --rpc-cors all \\\n    --rpc-methods auto \\\n    --prometheus-port 9615 \\\n    --prometheus-external \\\n    --state-cache-size 0 \\\n    --bootnodes \\\n        /dns/crispy.calamari.systems/tcp/30333/p2p/12D3KooWNE4LBfkYB2B7D4r9vL54YMMGsfAsXdkhWfBw8VHJSEQc \\\n        /dns/crunchy.calamari.systems/tcp/30333/p2p/12D3KooWL3ELxcoMGA6han3wPQoym5DKbYHqkWkCuqyjaCXpyJTt \\\n        /dns/hotdog.calamari.systems/tcp/30333/p2p/12D3KooWBdto53HnArmLdtf2RXzNWti7hD5mML7DWGZPD8q4cywv \\\n        /dns/tasty.calamari.systems/tcp/30333/p2p/12D3KooWGs2hfnRQ3Y2eAoUyWKUL3g7Jmcsf8FpyhVYeNpXeBMSu \\\n        /dns/tender.calamari.systems/tcp/30333/p2p/12D3KooWNXZeUSEKRPsp1yiDH99qSVawQSWHqG4umPjgHsn1joci \\\n    -- \\\n    --name 'my embedded relay node name' \\\n    --chain /usr/share/substrate/kusama.json \\\n    --port 31334 \\\n    --ws-port 9145 \\\n    --rpc-port 9134 \\\n    --prometheus-port 9616 \\\n    --prometheus-external \\\n    --telemetry-url 'wss://api.telemetry.manta.systems/submit/ 0'\n"))),(0,l.kt)(d,{value:"ubuntu",label:"ubuntu",mdxType:"TabItem"},(0,l.kt)("p",null,"edit the calamari service unit file to include collation parameters in the ",(0,l.kt)("inlineCode",{parentName:"p"},"ExecStart")," command."),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"/usr/lib/systemd/system/calamari.service")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ini"},"ExecStart=/usr/bin/calamari \\\n    --collator \\\n    --name 'my parachain collator node name' \\\n    --chain /usr/share/substrate/calamari.json \\\n    --base-path /var/lib/substrate \\\n    --port 31333 \\\n    --ws-port 9144 \\\n    --ws-max-connections 100 \\\n    --rpc-port 9133 \\\n    --rpc-cors all \\\n    --rpc-methods auto \\\n    --prometheus-port 9615 \\\n    --prometheus-external \\\n    --state-cache-size 0 \\\n    --bootnodes \\\n        /dns/crispy.calamari.systems/tcp/30333/p2p/12D3KooWNE4LBfkYB2B7D4r9vL54YMMGsfAsXdkhWfBw8VHJSEQc \\\n        /dns/crunchy.calamari.systems/tcp/30333/p2p/12D3KooWL3ELxcoMGA6han3wPQoym5DKbYHqkWkCuqyjaCXpyJTt \\\n        /dns/hotdog.calamari.systems/tcp/30333/p2p/12D3KooWBdto53HnArmLdtf2RXzNWti7hD5mML7DWGZPD8q4cywv \\\n        /dns/tasty.calamari.systems/tcp/30333/p2p/12D3KooWGs2hfnRQ3Y2eAoUyWKUL3g7Jmcsf8FpyhVYeNpXeBMSu \\\n        /dns/tender.calamari.systems/tcp/30333/p2p/12D3KooWNXZeUSEKRPsp1yiDH99qSVawQSWHqG4umPjgHsn1joci \\\n    -- \\\n    --name 'my embedded relay node name' \\\n    --chain /usr/share/substrate/kusama.json \\\n    --port 31334 \\\n    --ws-port 9145 \\\n    --rpc-port 9134 \\\n    --prometheus-port 9616 \\\n    --prometheus-external \\\n    --telemetry-url 'wss://api.telemetry.manta.systems/submit/ 0'\n"))),(0,l.kt)(d,{value:"linux",label:"other linux",mdxType:"TabItem"},(0,l.kt)("p",null,"edit the calamari service unit file to include collation parameters in the ",(0,l.kt)("inlineCode",{parentName:"p"},"ExecStart")," command."),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"/etc/systemd/system/calamari.service")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ini"},"ExecStart=/usr/local/bin/calamari \\\n    --collator \\\n    --name 'my parachain collator node name' \\\n    --chain /usr/share/substrate/calamari.json \\\n    --base-path /var/lib/substrate \\\n    --port 31333 \\\n    --ws-port 9144 \\\n    --ws-max-connections 100 \\\n    --rpc-port 9133 \\\n    --rpc-cors all \\\n    --rpc-methods auto \\\n    --prometheus-port 9615 \\\n    --prometheus-external \\\n    --state-cache-size 0 \\\n    --bootnodes \\\n        /dns/crispy.calamari.systems/tcp/30333/p2p/12D3KooWNE4LBfkYB2B7D4r9vL54YMMGsfAsXdkhWfBw8VHJSEQc \\\n        /dns/crunchy.calamari.systems/tcp/30333/p2p/12D3KooWL3ELxcoMGA6han3wPQoym5DKbYHqkWkCuqyjaCXpyJTt \\\n        /dns/hotdog.calamari.systems/tcp/30333/p2p/12D3KooWBdto53HnArmLdtf2RXzNWti7hD5mML7DWGZPD8q4cywv \\\n        /dns/tasty.calamari.systems/tcp/30333/p2p/12D3KooWGs2hfnRQ3Y2eAoUyWKUL3g7Jmcsf8FpyhVYeNpXeBMSu \\\n        /dns/tender.calamari.systems/tcp/30333/p2p/12D3KooWNXZeUSEKRPsp1yiDH99qSVawQSWHqG4umPjgHsn1joci \\\n    -- \\\n    --name 'my embedded relay node name' \\\n    --chain /usr/share/substrate/kusama.json \\\n    --port 31334 \\\n    --ws-port 9145 \\\n    --rpc-port 9134 \\\n    --prometheus-port 9616 \\\n    --prometheus-external \\\n    --telemetry-url 'wss://api.telemetry.manta.systems/submit/ 0'\n")))),(0,l.kt)("h3",{id:"parameters-with-special-significance-for-collator-maintainers"},"parameters with special significance for collator maintainers"),(0,l.kt)("p",null,"two sets of parameters are supplied to the substrate node binary (calamari), separated by a double-dash (",(0,l.kt)("inlineCode",{parentName:"p"},"--"),"). the first set controls the behavior of the parachain node. the second set controls the behaviour of the embedded relay-chain node."),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"significant ",(0,l.kt)("strong",{parentName:"li"},"parachain")," parameters",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"--collator"),": run in collator mode. behaves the same as ",(0,l.kt)("inlineCode",{parentName:"li"},"--validator")," on relay chains. setting this also causes pruning mode to be set to ",(0,l.kt)("inlineCode",{parentName:"li"},"archive")," (like ",(0,l.kt)("inlineCode",{parentName:"li"},"--pruning archive"),")."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"--name"),": parachain node name, displayed on ",(0,l.kt)("a",{parentName:"li",href:"https://telemetry.manta.systems/#list/0x4ac80c99289841dd946ef92765bf659a307d39189b3ce374a92b5f0415ee17a1"},"calamari telemetry"),"."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"--port"),": parachain peer-to-peer port. calamari default is 31333. this port must be accessible over the internet to other calamari nodes."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"--prometheus-port"),": parachain metrics port. calamari default is 9615. this port must be accessible to the manta metrics monitor at: ",(0,l.kt)("inlineCode",{parentName:"li"},"18.156.192.254")," (",(0,l.kt)("inlineCode",{parentName:"li"},"18.156.192.254/32")," if you are specifying by subnet)"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"--prometheus-external"),": if you are not reverse proxying metrics over ssl, you may need to set this parameter to tell the embedded metrics server to listen on the ",(0,l.kt)("em",{parentName:"li"},"all ips")," socket (",(0,l.kt)("inlineCode",{parentName:"li"},"0.0.0.0:9615"),") rather than ",(0,l.kt)("em",{parentName:"li"},"localhost only")," (",(0,l.kt)("inlineCode",{parentName:"li"},"127.0.0.1:9615"),")"))),(0,l.kt)("li",{parentName:"ul"},"significant ",(0,l.kt)("strong",{parentName:"li"},"relay-chain")," parameters",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"--name"),": relay-chain node name, displayed on ",(0,l.kt)("a",{parentName:"li",href:"https://telemetry.manta.systems/#list/0xb0a8d493285c2df73290dfb7e61f870f17b41801197a149ca93654499ea3dafe"},"kusama telemetry"),"."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"--port"),": relay-chain peer-to-peer port. calamari-embedded-kusama default is 31334. this port must be accessible over the internet to other kusama nodes."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"--prometheus-port"),": relay-chain metrics port. calamari-embedded-kusama default is 9616. this port must be accessible to the manta metrics monitor at: ",(0,l.kt)("inlineCode",{parentName:"li"},"18.156.192.254")," (",(0,l.kt)("inlineCode",{parentName:"li"},"18.156.192.254/32")," if you are specifying by subnet)"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"--prometheus-external"),": if you are not reverse proxying metrics over ssl, you may need to set this parameter to tell the embedded metrics server to listen on the ",(0,l.kt)("em",{parentName:"li"},"all ips")," socket (",(0,l.kt)("inlineCode",{parentName:"li"},"0.0.0.0:9616"),") rather than ",(0,l.kt)("em",{parentName:"li"},"localhost only")," (",(0,l.kt)("inlineCode",{parentName:"li"},"127.0.0.1:9616"),")")))),(0,l.kt)("h3",{id:"firewall-configuration"},"firewall configuration"),(0,l.kt)("p",null,"several ports are required to be accessible from outside of the node host in order for the collator to function well. for simplicity, the settings documented below use the default ports, however feel free to use alternative ports as required by your infrastructure and network topology."),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("strong",{parentName:"li"},"31333"),": default calamari peer-to-peer port"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("strong",{parentName:"li"},"31334"),": default (embedded-relay) kusama peer-to-peer port"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("strong",{parentName:"li"},"9615"),": default calamari metrics port"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("strong",{parentName:"li"},"9616"),": default (embedded-relay) kusama metrics port")),(0,l.kt)("p",null,"you should monitor your own collator using the techniques described on the ",(0,l.kt)("a",{parentName:"p",href:"https://wiki.polkadot.network/docs/maintain-guides-how-to-monitor-your-node"},"polkadot wiki"),". the metrics exposed on ports 9615 and 9616 facilitate this, so these ports should be accessible both from your own prometheus/alertmanager server (which you should configure to alert you) and manta's ",(0,l.kt)("a",{parentName:"p",href:"https://pulse.pelagos.systems"},"pulse server")," at ",(0,l.kt)("inlineCode",{parentName:"p"},"18.156.192.254")," (which is monitored by manta devops)."),(0,l.kt)("p",null,"it is good practice to serve your metrics over ssl (so that their authenticity can be validated). an easy way to accomplish this is to install certbot and nginx and configure a reverse proxy listening on port 443 and proxying requests to the metrics ports."),(0,l.kt)("p",null,"the example below assumes:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"you administer the domain ",(0,l.kt)("strong",{parentName:"li"},"example.com")),(0,l.kt)("li",{parentName:"ul"},"its dns is managed by cloudflare"),(0,l.kt)("li",{parentName:"ul"},"your nodes hostname is ",(0,l.kt)("strong",{parentName:"li"},"bob")),(0,l.kt)("li",{parentName:"ul"},"your calamari node uses default ports"),(0,l.kt)("li",{parentName:"ul"},"your internet gateway (router) port forwards 443/ssl traffic arriving on the routers wan interface to your collator node"),(0,l.kt)("li",{parentName:"ul"},"you have certbot installed, ideally as a snap (",(0,l.kt)("a",{parentName:"li",href:"https://certbot.eff.org/instructions"},"instructions"),")"),(0,l.kt)("li",{parentName:"ul"},"you have version 2.3.1 or later of ",(0,l.kt)("a",{parentName:"li",href:"https://certbot-dns-cloudflare.readthedocs.io/en/stable/"},"certbot-dns-cloudflare")," installed (",(0,l.kt)("a",{parentName:"li",href:"https://snapcraft.io/certbot-dns-cloudflare"},"instructions"),")")),(0,l.kt)("p",null,"set up ssl port forwarding"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"request a cert"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"#!/bin/bash\n\nsudo certbot certonly \\\n  --dns-cloudflare \\\n  --dns-cloudflare-credentials .cloudflare-credentials \\\n  -d bob.example.com \\\n  -d calamari.metrics.bob.example.com \\\n  -d kusama.metrics.bob.example.com\n"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"configure nginx ",(0,l.kt)("inlineCode",{parentName:"p"},"/etc/nginx/sites-enabled/example.com.conf")),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre"},'server {\n  server_name calamari.metrics.bob.example.com;\n  listen 443 ssl;\n  gzip off;\n  location / {\n    proxy_pass http://127.0.0.1:9615;\n    proxy_http_version 1.1;\n    proxy_set_header X-Real-IP $remote_addr;\n    proxy_set_header Host $host;\n    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n    proxy_set_header Upgrade $http_upgrade;\n    proxy_set_header Connection "upgrade";\n  }\n  ssl_certificate /etc/letsencrypt/live/example.com/fullchain.pem;\n  ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem;\n  include /etc/letsencrypt/options-ssl-nginx.conf;\n  ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;\n}\n\nserver {\n  server_name kusama.metrics.bob.example.com;\n  listen 443 ssl;\n  gzip off;\n  location / {\n    proxy_pass http://127.0.0.1:9616;\n    proxy_http_version 1.1;\n    proxy_set_header X-Real-IP $remote_addr;\n    proxy_set_header Host $host;\n    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n    proxy_set_header Upgrade $http_upgrade;\n    proxy_set_header Connection "upgrade";\n  }\n  ssl_certificate /etc/letsencrypt/live/bob.example.com/fullchain.pem;\n  ssl_certificate_key /etc/letsencrypt/live/bob.example.com/privkey.pem;\n  include /etc/letsencrypt/options-ssl-nginx.conf;\n  ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;\n}\n')))),(0,l.kt)(u,{groupId:"os",mdxType:"Tabs"},(0,l.kt)(d,{value:"fedora",label:"fedora",mdxType:"TabItem"},(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"#!/bin/bash\n\ndefault_zone=$(sudo firewall-cmd --get-default-zone)\n\n# calamari p2p\nsudo firewall-cmd \\\n  --zone=${default_zone} \\\n  --add-port=31333/tcp \\\n  --permanent\n\n# kusama p2p\nsudo firewall-cmd \\\n  --zone=${default_zone} \\\n  --add-port=31334/tcp \\\n  --permanent\n\n# calamari metrics\nsudo firewall-cmd \\\n  --zone=${default_zone} \\\n  --add-port=9615/tcp \\\n  --permanent\n\n# kusama metrics\nsudo firewall-cmd \\\n  --zone=${default_zone} \\\n  --add-port=9616/tcp \\\n  --permanent\n\nsudo firewall-cmd --reload\n")))),(0,l.kt)("h2",{id:"running"},"Running"),(0,l.kt)(u,{groupId:"os",mdxType:"Tabs"},(0,l.kt)(d,{value:"docker",label:"docker",mdxType:"TabItem"},(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"start your docker node"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"docker run \\\n  -it \\\n  -p 9933:9933 \\\n  -p 30333:30333 \\\n  -v host_path:/container_path \\\n  --name your_container_name \\\n  mantanetwork/calamari:latest \\\n  --base-path /container_path/data \\\n  --keystore-path /container_path/keystore \\\n  --name your_collator_name \\\n  --rpc-cors all \\\n  --collator \\\n  --rpc-methods=unsafe \\\n  --unsafe-rpc-external\n")),(0,l.kt)("p",{parentName:"li"},"Examples of these name and paths:"),(0,l.kt)("p",{parentName:"li"},(0,l.kt)("inlineCode",{parentName:"p"},"host_path:/container_path")," => ",(0,l.kt)("inlineCode",{parentName:"p"},"~/my-calamari-db:/calamari")),(0,l.kt)("p",{parentName:"li"},(0,l.kt)("inlineCode",{parentName:"p"},"your_collator_name")," => ",(0,l.kt)("inlineCode",{parentName:"p"},"Community-Collator-1")),(0,l.kt)("p",{parentName:"li"},"Ensure you can see a line of log like this:"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"\ud83d\udc64 Role: AUTHORITY\n"))))),(0,l.kt)(d,{value:"fedora",label:"fedora",mdxType:"TabItem"},(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"check the status of the calamari service:"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"#!/bin/bash\n\nsystemctl status calamari.service\n"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"enable calamari service (the service will start automatically on system boot):"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"#!/bin/bash\n\nsudo systemctl enable calamari.service\n"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"start calamari service:"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"#!/bin/bash\n\nsudo systemctl start calamari.service\n"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"stop calamari service:"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"#!/bin/bash\n\nsudo systemctl stop calamari.service\n"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"tail the calamari service logs:"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"#!/bin/bash\n\njournalctl -u calamari.service -f\n"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"debug calamari service configuration (run calamari as the manta user, to quickly check for runtime errors):"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"#!/bin/bash\n\nsudo -H -u manta bash -c '/usr/bin/calamari --chain /usr/share/substrate/calamari.json --base-path /var/lib/substrate --port 31333 --ws-port 9144 --ws-max-connections 100 --rpc-port 9133 --rpc-cors all --rpc-methods safe --state-cache-size 0 --bootnodes /dns/crispy.calamari.systems/tcp/30333/p2p/12D3KooWNE4LBfkYB2B7D4r9vL54YMMGsfAsXdkhWfBw8VHJSEQc /dns/crunchy.calamari.systems/tcp/30333/p2p/12D3KooWL3ELxcoMGA6han3wPQoym5DKbYHqkWkCuqyjaCXpyJTt /dns/hotdog.calamari.systems/tcp/30333/p2p/12D3KooWBdto53HnArmLdtf2RXzNWti7hD5mML7DWGZPD8q4cywv /dns/tasty.calamari.systems/tcp/30333/p2p/12D3KooWGs2hfnRQ3Y2eAoUyWKUL3g7Jmcsf8FpyhVYeNpXeBMSu /dns/tender.calamari.systems/tcp/30333/p2p/12D3KooWNXZeUSEKRPsp1yiDH99qSVawQSWHqG4umPjgHsn1joci -- --chain /usr/share/substrate/kusama.json'\n"))))),(0,l.kt)(d,{value:"ubuntu",label:"ubuntu",mdxType:"TabItem"},(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"check the status of the calamari service:"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"#!/bin/bash\n\nsystemctl status calamari.service\n"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"enable calamari service (the service will start automatically on system boot):"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"#!/bin/bash\n\nsudo systemctl enable calamari.service\n"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"start calamari service:"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"#!/bin/bash\n\nsudo systemctl start calamari.service\n"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"stop calamari service:"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"#!/bin/bash\n\nsudo systemctl stop calamari.service\n"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"tail the calamari service logs:"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"#!/bin/bash\n\njournalctl -u calamari.service -f\n"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"debug calamari service configuration (run calamari as the manta user, to quickly check for runtime errors):"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"#!/bin/bash\n\nsudo -H -u manta bash -c '/usr/bin/calamari --chain /usr/share/substrate/calamari.json --base-path /var/lib/substrate --port 31333 --ws-port 9144 --ws-max-connections 100 --rpc-port 9133 --rpc-cors all --rpc-methods safe --state-cache-size 0 --bootnodes /dns/crispy.calamari.systems/tcp/30333/p2p/12D3KooWNE4LBfkYB2B7D4r9vL54YMMGsfAsXdkhWfBw8VHJSEQc /dns/crunchy.calamari.systems/tcp/30333/p2p/12D3KooWL3ELxcoMGA6han3wPQoym5DKbYHqkWkCuqyjaCXpyJTt /dns/hotdog.calamari.systems/tcp/30333/p2p/12D3KooWBdto53HnArmLdtf2RXzNWti7hD5mML7DWGZPD8q4cywv /dns/tasty.calamari.systems/tcp/30333/p2p/12D3KooWGs2hfnRQ3Y2eAoUyWKUL3g7Jmcsf8FpyhVYeNpXeBMSu /dns/tender.calamari.systems/tcp/30333/p2p/12D3KooWNXZeUSEKRPsp1yiDH99qSVawQSWHqG4umPjgHsn1joci -- --chain /usr/share/substrate/kusama.json'\n"))))),(0,l.kt)(d,{value:"linux",label:"other linux",mdxType:"TabItem"},(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"check the status of the calamari service:"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"#!/bin/bash\n\nsystemctl status calamari.service\n"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"enable calamari service (the service will start automatically on system boot):"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"#!/bin/bash\n\nsudo systemctl enable calamari.service\n"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"start calamari service:"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"#!/bin/bash\n\nsudo systemctl start calamari.service\n"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"stop calamari service:"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"#!/bin/bash\n\nsudo systemctl stop calamari.service\n"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"tail the calamari service logs:"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"#!/bin/bash\n\njournalctl -u calamari.service -f\n"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"debug calamari service configuration (run calamari as the manta user, to quickly check for runtime errors):"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"#!/bin/bash\n\nsudo -H -u manta bash -c '/usr/local/bin/calamari --chain /usr/share/substrate/calamari.json --base-path /var/lib/substrate --port 31333 --ws-port 9144 --ws-max-connections 100 --rpc-port 9133 --rpc-cors all --rpc-methods safe --state-cache-size 0 --bootnodes /dns/crispy.calamari.systems/tcp/30333/p2p/12D3KooWNE4LBfkYB2B7D4r9vL54YMMGsfAsXdkhWfBw8VHJSEQc /dns/crunchy.calamari.systems/tcp/30333/p2p/12D3KooWL3ELxcoMGA6han3wPQoym5DKbYHqkWkCuqyjaCXpyJTt /dns/hotdog.calamari.systems/tcp/30333/p2p/12D3KooWBdto53HnArmLdtf2RXzNWti7hD5mML7DWGZPD8q4cywv /dns/tasty.calamari.systems/tcp/30333/p2p/12D3KooWGs2hfnRQ3Y2eAoUyWKUL3g7Jmcsf8FpyhVYeNpXeBMSu /dns/tender.calamari.systems/tcp/30333/p2p/12D3KooWNXZeUSEKRPsp1yiDH99qSVawQSWHqG4umPjgHsn1joci -- --chain /usr/share/substrate/kusama.json'\n")))))),(0,l.kt)("h2",{id:"collator-session-aura-keys"},"Collator session (aura) keys"),(0,l.kt)("p",null,"to collate, two accounts/keys are required at any given time."),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("strong",{parentName:"li"},"collator account"),": this is the account that holds the collator bond of 400,000 KMA. it is also the account that the collator's share of transaction fees will be deposited into. the bond cannot be spent while the account is collating. the keys for this account should be protected carefully and should never exist on the filesystem of the collator node."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("strong",{parentName:"li"},"aura session key"),": this is a disposable account used by the collator node to author blocks. it is bound to the collator account. it is good practice to rotate the session key on a regular basis and up to once per session. substrate stores the keys for this account in the parachain keystore on the filesystem of the collator node (",(0,l.kt)("inlineCode",{parentName:"li"},"/var/lib/substrate/chains/calamari/keystore"),") when either of the author_insertKey or author_rotateKeys rpc methods are called.")),(0,l.kt)("p",null,"note: both of the following methods (insert, rotate) use an unsafe rpc call to set the node session key. you must stop the service if it is running, then run the node with the ",(0,l.kt)("inlineCode",{parentName:"p"},"--rpc-methods=unsafe")," parameter setting in order for the calls to succeed. don't forget to change the setting back to ",(0,l.kt)("inlineCode",{parentName:"p"},"safe")," afterwards as a node that allows unsafe rpc calls and has an exposed rpc port can easily have its session keys changed by anyone, reulting in transaction fees being paid out somewhere other than where they are intended."),(0,l.kt)(u,{groupId:"keys",mdxType:"Tabs"},(0,l.kt)(d,{value:"insert",label:"insert",mdxType:"TabItem"},(0,l.kt)("p",null,"this command demonstrates a session key insertion using a key created with ",(0,l.kt)("a",{parentName:"p",href:"https://docs.substrate.io/v3/tools/subkey"},"subkey"),"."),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"generate an aura key with subkey"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"#!/bin/bash\n\nsubkey generate \\\n  --scheme sr25519 \\\n  --network calamari \\\n  --output-type json \\\n  --words 12 \\\n  > ./aura.json\n"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"create an author_insertKey rpc payload"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'#!/bin/bash\n\necho \'{\n    "jsonrpc":"2.0",\n    "id":1,\n    "method":"author_insertKey",\n    "params": [\n      "aura",\n      "<mnemonic phrase>",\n      "<public key>"\n    ]\n  }\' | jq \\\n    --arg mnemonic "$(jq -r .secretPhrase ./aura.json)" \\\n    --arg public "$(jq -r .publicKey ./aura.json)" \\\n    \'. | .params[1] = $mnemonic | .params[2] = $public\' > ./payload.json\n'))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"execute the author_insertKey rpc payload"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"#!/bin/bash\n\ncurl \\\n  --header 'Content-Type: application/json;charset=utf-8' \\\n  --data @./payload.json \\\n  http://localhost:9133\n"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},(0,l.kt)("em",{parentName:"p"},"validation assertion"),": optionally, check that the aura mnemonic in use by the node, matches the one generated"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"#!/bin/bash\n\nsudo -H -u manta cat /var/lib/substrate/chains/calamari/keystore/$(sudo -H -u manta ls /var/lib/substrate/chains/calamari/keystore/)\n"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},(0,l.kt)("em",{parentName:"p"},"validation assertion"),": optionally, check that the service logs show that the node is running with role: ",(0,l.kt)("inlineCode",{parentName:"p"},"AUTHORITY")," (check the timestamps)"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"#!/bin/bash\n\njournalctl -u calamari.service -g AUTHORITY\n"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},(0,l.kt)("em",{parentName:"p"},"clean up"),": remove secrets from the filesystem that were created when generated and for the payload"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"#!/bin/bash\n\nrm ./aura.json ./payload.json\n"))))),(0,l.kt)(d,{value:"rotate",label:"rotate",mdxType:"TabItem"},(0,l.kt)("p",null,"this command demonstrates a session key rotation. if no session key exists, one is created."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'#!/bin/bash\n\ncurl -H \'Content-Type: application/json\' --data \'{ "jsonrpc":"2.0", "method":"author_rotateKeys", "id":1 }\' http://localhost:9933\n')),(0,l.kt)("p",null,"the output from the rpc call should look like this (the ",(0,l.kt)("inlineCode",{parentName:"p"},"result")," property contains the hex representation of the aura session account's ",(0,l.kt)("em",{parentName:"p"},"public")," key):"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-json"},'{"jsonrpc":"2.0","result":"0x06736e65ab33fd1e4e3e434a1fa2c5425f0e263ddb50e6aeb15951288c562f61","id":1}\n')))),(0,l.kt)("h3",{id:"bind-the-collator-account-to-the-aura-session-key"},"bind the collator account to the aura session key"),(0,l.kt)("p",null,"note: if your collator node logs do not contain both ",(0,l.kt)("inlineCode",{parentName:"p"},"[Relaychain] \ud83d\udca4 Idle")," and ",(0,l.kt)("inlineCode",{parentName:"p"},"[Parachain] \ud83d\udca4 Idle")," messages, your node is still syncing. ",(0,l.kt)("strong",{parentName:"p"},"do not bind")," a collator account to an aura session key for a node whose sync is incomplete. doing so will result in ejection of your collator."),(0,l.kt)("p",null,"account binding is accomplished on-chain. the simplest way to do this, is with polkadot.js."),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"load ",(0,l.kt)("a",{parentName:"li",href:"https://polkadot.js.org/apps/?rpc=wss%3A%2F%2Fws.calamari.systems%2F#/extrinsics"},"calamari/developer/extrinsics")," in a browser:\n",(0,l.kt)("img",{alt:"session.setkeys()",src:t(9108).Z}),(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},'in the first box, labelled "using the selected account", select the collator account holding the 400,000 KMA collator bond.'),(0,l.kt)("li",{parentName:"ul"},'in the second (dropdown) box labelled "submit the following extrinsic", select ',(0,l.kt)("inlineCode",{parentName:"li"},"session"),"."),(0,l.kt)("li",{parentName:"ul"},"in the third (dropdown) box, select ",(0,l.kt)("inlineCode",{parentName:"li"},"setKeys(keys, proof)")),(0,l.kt)("li",{parentName:"ul"},"in both the fourth box and fifth boxes, labelled ",(0,l.kt)("inlineCode",{parentName:"li"},"aura: SpConsensusAuraSr25519AppSr25519Public")," and ",(0,l.kt)("inlineCode",{parentName:"li"},"proof: Bytes"),", enter the hex public key of the aura session key."),(0,l.kt)("li",{parentName:"ul"},"click on the ",(0,l.kt)("inlineCode",{parentName:"li"},"Submit Transaction")," button and wait for confirmation (a green tick), to appear in the upper right corner of the browser window."))),(0,l.kt)("li",{parentName:"ul"},"verify that the collator account and the aura session key are ",(0,l.kt)("em",{parentName:"li"},"bound")," by loading ",(0,l.kt)("a",{parentName:"li",href:"https://polkadot.js.org/apps/?rpc=wss%3A%2F%2Fws.calamari.systems%2F#/chainstate"},"calamari/developer/chain state")," in a browser:\n",(0,l.kt)("img",{alt:"session.nextkeys()",src:t(1207).Z}),(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},'in the first (dropdown) box, labelled "selected state query", select ',(0,l.kt)("inlineCode",{parentName:"li"},"session"),"."),(0,l.kt)("li",{parentName:"ul"},"in the second (dropdown) box, select ",(0,l.kt)("inlineCode",{parentName:"li"},"nextKeys(AccountId32): Option<CalamariRuntimeOpaqueSessionKeys>"),"."),(0,l.kt)("li",{parentName:"ul"},"in the third (dropdown) box, select the collator account holding the 400,000 KMA collator bond."),(0,l.kt)("li",{parentName:"ul"},"leave the ",(0,l.kt)("inlineCode",{parentName:"li"},"include option")," checkbox selected."),(0,l.kt)("li",{parentName:"ul"},"leave the ",(0,l.kt)("inlineCode",{parentName:"li"},"blockhash to query at")," box set to the default ",(0,l.kt)("inlineCode",{parentName:"li"},"0x")," value."),(0,l.kt)("li",{parentName:"ul"},"click on the small plus (",(0,l.kt)("inlineCode",{parentName:"li"},"+"),") icon to the right of the second dropdown box."),(0,l.kt)("li",{parentName:"ul"},"verify that a new box labelled ",(0,l.kt)("inlineCode",{parentName:"li"},"session.nextKeys(AccountId32): Option<CalamariRuntimeOpaqueSessionKeys>")," appears and contains a json object whose ",(0,l.kt)("inlineCode",{parentName:"li"},"aura")," value is set to the aura session hex public key generated earlier.")))),(0,l.kt)("h2",{id:"sync"},"Sync"),(0,l.kt)("p",null,"if you have no peers on the relaychain or your node is failing to verify new blocks, ensure your node\u2019s clock is accurate, ie. by syncing with an ntp timeserver."),(0,l.kt)("p",null,"you must sync both the calamari parachain and kusama relay-chain before the motion to include your collator is passed. completely synced substrate blockchain nodes will show an idle state in their logs for both ",(0,l.kt)("inlineCode",{parentName:"p"},"[Relaychain]")," and ",(0,l.kt)("inlineCode",{parentName:"p"},"[Parachain]")," and looks like so:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell="},"2022-03-01 17:18:58 [Parachain] \ud83d\udca4 Idle (49 peers), best: #1037783 (0xa0c5\u202604a8), finalized #1037781 (0xabd5\u20261c05), \u2b07 16.7kiB/s \u2b06 14.5kiB/s\n2022-03-01 17:18:55 [Relaychain] \ud83d\udca4 Idle (49 peers), best: #11619808 (0x24a5\u2026ad58), finalized #11619804 (0xa362\u20262df4), \u2b07 478.0kiB/s \u2b06 520.5kiB/s\n")),(0,l.kt)("p",null,"if your collator node logs do not contain both ",(0,l.kt)("inlineCode",{parentName:"p"},"[Relaychain] \ud83d\udca4 Idle")," and ",(0,l.kt)("inlineCode",{parentName:"p"},"[Parachain] \ud83d\udca4 Idle")," messages, your node is still syncing. do not bind a collator account to an aura session key for a node whose sync is incomplete. doing so will result in ejection of your collator."),(0,l.kt)("p",null,"the best way to sync is to just run your node until the idle messages show up in your logs. doing so may take up to 2 weeks, however it will also give you a perfect, cryptographically validated and complete history of the blockchains you are syncing."),(0,l.kt)("p",null,"if you cannot wait for the recommended sync mechanism to complete, you may obtain a fast-sync copy of the calamari and kusama blockchains taken from manta's backup nodes. to do so:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"stop your calamari service"),(0,l.kt)("li",{parentName:"ul"},"delete your calamari and kusama databases from the basepath (taking care not to delete your keystores which are also under the basepath)"),(0,l.kt)("li",{parentName:"ul"},"fetch a copy of the blockchains, extracting if required"),(0,l.kt)("li",{parentName:"ul"},"ensure that the entire basepath and all of its contents are owned by the user your node runs under (change ownership recursively if required)"),(0,l.kt)("li",{parentName:"ul"},"start your calamari service"),(0,l.kt)("li",{parentName:"ul"},"verify that the node is syncing correctly"),(0,l.kt)("li",{parentName:"ul"},"wait for both parachain and relay-chain idle messages to appear in the logs")),(0,l.kt)("p",null,"fast-sync commands (requires ",(0,l.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html"},"aws cli"),"):"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"#!/bin/bash\n\n# stop calamari service\nsudo systemctl stop calamari.service\n\n# sync calamari blockchain database\nsudo -H -u manta aws s3 sync --region eu-central-1 --no-sign-request --delete s3://calamari-kusama/var/lib/substrate/chains/calamari/db/full /var/lib/substrate/chains/calamari/db/full\n\n# sync kusama blockchain database\nsudo -H -u manta aws s3 sync --region eu-central-1 --no-sign-request --delete s3://calamari-kusama/var/lib/substrate/polkadot/chains/ksmcc3/db/full /var/lib/substrate/polkadot/chains/ksmcc3/db/full\n\n# update database `current` manifests\nsudo -H -u manta bash -c 'basename $(ls /var/lib/substrate/chains/calamari/db/full/MANIFEST-*) > /var/lib/substrate/chains/calamari/db/full/CURRENT'\nsudo -H -u manta bash -c 'basename $(ls /var/lib/substrate/polkadot/chains/ksmcc3/db/full/MANIFEST-*) > /var/lib/substrate/polkadot/chains/ksmcc3/db/full/CURRENT'\nsudo -H -u manta bash -c 'basename $(ls /var/lib/substrate/polkadot/chains/ksmcc3/db/full/parachains/db/MANIFEST-*) > /var/lib/substrate/polkadot/chains/ksmcc3/db/full/parachains/db/CURRENT'\n")),(0,l.kt)("h2",{id:"wait"},"Wait"),(0,l.kt)("p",null,"Ensure you have completed the ",(0,l.kt)("a",{parentName:"p",href:"https://docs.google.com/forms/d/e/1FAIpQLScizDDMq7jWeOPVVEMr3EY_Z6N6ugdkL8aKgAbZ9lAJX6DEOQ/viewform"},"collator application")," form. If approved, Calamari council will submit a motion to promote you as a candidate."),(0,l.kt)("p",null,"Note: Candidate doesn\u2019t mean your node is collator. For example, if there are 3 candidate places, and other candidates occupy all places, whilst you\u2019re in 4th position, you have to wait until a node is unregistered or new collator places are opened by the council."),(0,l.kt)("p",null,"If your collator gets a place, two sessions (",(0,l.kt)("inlineCode",{parentName:"p"},"12")," to ",(0,l.kt)("inlineCode",{parentName:"p"},"24")," hours) after the candidacy motion passes, you will see blocks produced by your collator in the ",(0,l.kt)("a",{parentName:"p",href:"https://polkadot.js.org/apps/?rpc=wss%3A%2F%2Fws.calamari.systems%2F#/explorer"},"explorer"),"."))}g.isMDXComponent=!0},1207:function(e,a){a.Z="data:image/png;base64,dmVyc2lvbiBodHRwczovL2dpdC1sZnMuZ2l0aHViLmNvbS9zcGVjL3YxCm9pZCBzaGEyNTY6Y2FkMWJkOTE1YjMxZjg5YWJlZDdjNmJjZjcyM2Q4ZGE1NTYwODY0ODFhMzRiNDk0OThmNzcwZWI4OWIzYWVlNQpzaXplIDcxMDY4Cg=="},9108:function(e,a){a.Z="data:image/png;base64,dmVyc2lvbiBodHRwczovL2dpdC1sZnMuZ2l0aHViLmNvbS9zcGVjL3YxCm9pZCBzaGEyNTY6Y2I1NDQ3OGIyOTBhZjRjYmI4NmRhMzVkYTAxZmMxYTg0ZTY3YzVmNjFkNjNjMWE4NTBlOGEwYmY1ZmQ5MGYwZQpzaXplIDU3MjY0Cg=="}}]);